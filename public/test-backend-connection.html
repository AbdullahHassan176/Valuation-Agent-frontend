<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; border-radius: 5px; }
        .success { background: #0d4f0d; border-color: #4caf50; }
        .error { background: #4d0d0d; border-color: #f44336; }
        .info { background: #0d2d4d; border-color: #2196f3; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:active { transform: translateY(1px); }
        pre { background: #2a2a2a; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        h1 { color: #4caf50; text-align: center; }
        h3 { margin-top: 0; color: #fff; }
        .button-group { text-align: center; margin: 20px 0; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-info { background: #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Backend Connection Test</h1>
    <p>Testing connection to: <code>https://valuation-backend-api-cadmfqgxgzawa7fp.canadacentral-01.azurewebsites.net</code></p>
    
    <div id="results"></div>
    
    <div class="button-group">
        <button onclick="testConnection()">ğŸ§ª Test Backend Connection</button>
        <button onclick="testHealth()">ğŸ’š Test Health Check</button>
        <button onclick="testValuationRuns()">ğŸ“Š Test Valuation Runs</button>
        <button onclick="testCreateRun()">â• Test Create Run</button>
        <br>
        <button onclick="testChatGPT()">ğŸ¤– Test ChatGPT Endpoint</button>
        <button onclick="testAllEndpoints()">ğŸ” Test All Endpoints</button>
        <button onclick="testBothServices()">ğŸ”„ Test Both Services</button>
        <button onclick="testEnvironmentDetection()">ğŸŒ Test Environment Detection</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
    </div>

    <script>
        const BACKEND_URL = 'https://valuation-backend-ephph9gkdjcca0c0.canadacentral-01.azurewebsites.net';
        const API_URL = 'https://valuation-backend-api-cadmfqgxgzawa7fp.canadacentral-01.azurewebsites.net';
        
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testConnection() {
            addResult('ğŸ” Testing Basic Connection', 'Testing GET / endpoint...', 'info');
            
            try {
                const response = await fetch(BACKEND_URL + '/');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Basic Connection Success', JSON.stringify(data, null, 2), 'success');
                } else {
                    addResult('âŒ Basic Connection Failed', `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                addResult('âŒ Connection Error', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testHealth() {
            addResult('ğŸ’š Testing Health Check', 'Testing GET /healthz endpoint...', 'info');
            
            try {
                const response = await fetch(BACKEND_URL + '/healthz');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Health Check Success', JSON.stringify(data, null, 2), 'success');
                } else {
                    addResult('âŒ Health Check Failed', `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                addResult('âŒ Health Check Error', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testValuationRuns() {
            addResult('ğŸ“Š Testing Valuation Runs', 'Testing GET /api/valuation/runs endpoint...', 'info');
            
            try {
                const response = await fetch(BACKEND_URL + '/api/valuation/runs');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Valuation Runs Success', `Found ${data.length} runs:\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    addResult('âŒ Valuation Runs Failed', `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                addResult('âŒ Valuation Runs Error', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testCreateRun() {
            addResult('â• Testing Create Run', 'Testing POST /api/valuation/runs endpoint...', 'info');
            
            const testRun = {
                spec: {
                    type: "IRS",
                    ccy: "USD",
                    notional: 1000000,
                    effective: "2024-01-15",
                    maturity: "2029-01-15",
                    fixedRate: 4.25,
                    floatIndex: "SOFR-3M"
                },
                asOf: "2024-01-15",
                marketDataProfile: "default",
                approach: ["OIS_discounting"]
            };
            
            try {
                const response = await fetch(BACKEND_URL + '/api/valuation/runs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testRun)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… Create Run Success', `Run created with ID: ${data.id || data.run_id}\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    addResult('âŒ Create Run Failed', `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                addResult('âŒ Create Run Error', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testChatGPT() {
            addResult('ğŸ¤– Testing ChatGPT Endpoint', 'Testing POST /poc/chat endpoint...', 'info');
            
            try {
                const response = await fetch(BACKEND_URL + '/poc/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: 'Hello! This is a test message.' })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('âœ… ChatGPT Endpoint Success', JSON.stringify(data, null, 2), 'success');
                } else {
                    addResult('âŒ ChatGPT Endpoint Failed', `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                addResult('âŒ ChatGPT Error', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testEnvironmentDetection() {
            addResult('ğŸŒ Testing Environment Detection', 'Testing frontend environment detection logic...', 'info');
            
            const envInfo = {
                hostname: window.location.hostname,
                href: window.location.href,
                isLocalhost: ['localhost', '127.0.0.1'].includes(window.location.hostname),
                isAzure: window.location.hostname.includes('azurestaticapps.net'),
                isProduction: !['localhost', '127.0.0.1'].includes(window.location.hostname),
                userAgent: navigator.userAgent,
                protocol: window.location.protocol
            };
            
            const expectedBackend = envInfo.isLocalhost 
                ? 'http://localhost:9000' 
                : 'https://valuation-backend-api-cadmfqgxgzawa7fp.canadacentral-01.azurewebsites.net';
            
            addResult('âœ… Environment Detection', 
                `Environment Info:\n${JSON.stringify(envInfo, null, 2)}\n\nExpected Backend: ${expectedBackend}`, 
                'success');
        }
        
        async function testBothServices() {
            addResult('ğŸ”„ Testing Both Services', 'Testing Backend and API services...', 'info');
            
            // Test Backend Service (LangGraph Orchestrator)
            try {
                const backendResponse = await fetch(BACKEND_URL + '/healthz');
                const backendData = await backendResponse.json();
                
                if (backendResponse.ok) {
                    addResult('âœ… Backend Service (LangGraph)', 
                        `Status: ${backendResponse.status}\nResponse: ${JSON.stringify(backendData, null, 2)}`, 
                        'success');
                } else {
                    addResult('âŒ Backend Service (LangGraph)', 
                        `Status: ${backendResponse.status}\nResponse: ${JSON.stringify(backendData, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                addResult('âŒ Backend Service (LangGraph)', `Error: ${error.message}`, 'error');
            }
            
            // Test API Service (Valuation Engine)
            try {
                const apiResponse = await fetch(API_URL + '/healthz');
                const apiData = await apiResponse.json();
                
                if (apiResponse.ok) {
                    addResult('âœ… API Service (Valuation)', 
                        `Status: ${apiResponse.status}\nResponse: ${JSON.stringify(apiData, null, 2)}`, 
                        'success');
                } else {
                    addResult('âŒ API Service (Valuation)', 
                        `Status: ${apiResponse.status}\nResponse: ${JSON.stringify(apiData, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                addResult('âŒ API Service (Valuation)', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testAllEndpoints() {
            const endpoints = [
                { name: 'Health Check', url: '/healthz', method: 'GET' },
                { name: 'API Info', url: '/', method: 'GET' },
                { name: 'Valuation Runs (GET)', url: '/api/valuation/runs', method: 'GET' },
                { name: 'Curves', url: '/api/valuation/curves', method: 'GET' },
                { name: 'Chat (GET)', url: '/poc/chat', method: 'GET' },
                { name: 'IFRS Ask', url: '/poc/ifrs-ask', method: 'GET' },
                { name: 'Parse Contract', url: '/poc/parse-contract', method: 'GET' },
                { name: 'Explain Run', url: '/poc/explain-run', method: 'GET' }
            ];
            
            addResult('ğŸ” Testing All Endpoints', 'Running comprehensive endpoint tests...', 'info');
            
            for (const endpoint of endpoints) {
                try {
                    const options = {
                        method: endpoint.method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    
                    if (endpoint.method === 'POST') {
                        options.body = JSON.stringify({ message: 'Test message' });
                    }
                    
                    const response = await fetch(BACKEND_URL + endpoint.url, options);
                    
                    // Try to parse as JSON, but handle non-JSON responses
                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = await response.text();
                    }
                    
                    if (response.ok) {
                        addResult(`âœ… ${endpoint.name}`, 
                            typeof data === 'string' ? data : JSON.stringify(data, null, 2), 
                            'success');
                    } else {
                        addResult(`âŒ ${endpoint.name}`, 
                            `Status: ${response.status}\nResponse: ${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}`, 
                            'error');
                    }
                } catch (error) {
                    addResult(`âŒ ${endpoint.name}`, `Error: ${error.message}`, 'error');
                }
            }
        }
        
        // Auto-run basic tests on page load
        window.onload = function() {
            addResult('ğŸš€ Page Loaded', 'Running automatic tests...', 'info');
            
            // Auto-run environment detection and health check
            setTimeout(() => {
                testEnvironmentDetection();
            }, 500);
            
            setTimeout(() => {
                testHealth();
            }, 1000);
            
            setTimeout(() => {
                testConnection();
            }, 1500);
        };
    </script>
</body>
</html>
